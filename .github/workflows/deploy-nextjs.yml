name: Build, Push and Deploy Next.js

on:
  push:
    branches:
      - "*"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Log in to GitHub Container Registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Build and Push Docker image
        run: |
          IMAGE_NAME=ghcr.io/${{ github.repository }}/batamdev-app:latest
          echo "Building image: $IMAGE_NAME"
          docker build -t $IMAGE_NAME .
          docker push $IMAGE_NAME

  deploy:
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Test SSH connection
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            echo "‚úÖ SSH connection OK"

      - name: Deploy to production server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd /opt/batamdev/web

            echo "üöÄ Pulling latest image..."
            sudo docker pull ghcr.io/jokorezky/new-batamdev/batamdev-app:latest

            echo "üõë Stopping existing container..."
            sudo docker stop batamdev-nextjs || true
            sudo docker rm batamdev-nextjs || true

            echo "üîß Creating network skildev-net if not exists..."
            sudo docker network create skildev-net || true

            echo "üê≥ Starting new container..."
            sudo docker run -d \
              --name batamdev-nextjs \
              --env-file /opt/batamdev/web/.env \
              -p 3008:3008 \
              --restart unless-stopped \
              ghcr.io/jokorezky/new-batamdev/batamdev-app:latest

            echo "üîó Connecting containers to skildev-net..."
            sudo docker network connect skildev-net batamdev-nextjs || true
            sudo docker network connect skildev-net npm || true
            sudo docker network connect skildev-net api-kinigo || true

            echo "‚úÖ Checking container status..."
            sleep 5
            sudo docker ps -f name=batamdev-nextjs
            echo "üéâ Deployment completed successfully!"

      - name: Prepare safe commit message
        id: escape_commit
        run: |
          MSG="${{ github.event.head_commit.message }}"
          MSG_ESCAPED=$(echo "$MSG" | sed -E 's/&/&amp;/g; s/_/\\_/g; s/\*/\\*/g; s/`/\\`/g; s/>/\\>/g; s/</\\</g')
          echo "commit_message=$MSG_ESCAPED" >> $GITHUB_OUTPUT

      # - name: Send Telegram notification
      #   uses: appleboy/telegram-action@v1.0.0
      #   with:
      #     to: ${{ secrets.TELEGRAM_CHAT_ID }}
      #     token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      #     message: |
      #       üöÄ DEPLOYMENT Next.js Kinigo
      #       Status: ‚úÖ Live
      #       Commit: ${{ github.event.head_commit.message }}
      #       URL: https://kinigo.id
      #     parse_mode: html
      #   if: success()

      # - name: Send Telegram failure notification
      #   uses: appleboy/telegram-action@v1.0.0
      #   with:
      #     to: ${{ secrets.TELEGRAM_CHAT_ID }}
      #     token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      #     message: |
      #       ‚ùå DEPLOYMENT GAGAL - Next.js Kinigo
      #       Commit: ${{ github.event.head_commit.message }}
      #       Waktu: $(date '+%Y-%m-%d %H:%M:%S')
      #       ‚ùó Silakan cek logs GitHub Actions untuk detail error!
      #     parse_mode: html
      #   if: failure()
